---
interface Props {
  title?: string;
  description?: string;
  activeNav?: 'home' | 'try' | 'learn' | 'doc' | 'stdlib' | 'blog' | 'about';
}

const {
  title = 'Elo â€” An expression language',
  description = 'A simple, well-designed, portable, and safe data expression language that compiles to JavaScript, Ruby, and SQL.',
  activeNav = 'home'
} = Astro.props;

// Helper to prefix paths with base URL
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const url = (path: string) => `${base}${path}`;
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content={description}>
  <title>{title}</title>
  <link rel="stylesheet" href={url('/styles/global.css')}>
  <script>
    // Apply theme immediately to avoid flash
    const storedTheme = localStorage.getItem('elo-theme');
    const isLightMode = storedTheme ? storedTheme === 'light' : true;
    if (isLightMode) {
      document.body.classList.add('light-theme');
    }
  </script>
</head>
<body>
  <header>
    <a href={url('/')} class="logo">
      <svg class="logo-icon" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="8" y="10" width="20" height="5" rx="2.5" fill="currentColor"/>
        <rect x="8" y="21.5" width="28" height="5" rx="2.5" fill="currentColor"/>
        <rect x="8" y="33" width="20" height="5" rx="2.5" fill="currentColor"/>
        <path d="M36 24L42 28V20L36 24Z" fill="currentColor"/>
      </svg>
      Elo
    </a>
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle menu">
      <span class="hamburger-icon"></span>
    </button>
    <nav id="main-nav">
      <a href={url('/')} class:list={[{ active: activeNav === 'home' }]}>Home</a>
      <a href={url('/try')} class:list={[{ active: activeNav === 'try' }]}>Try</a>
      <div class="nav-group">
        <a href={url('/learn')} class:list={[{ active: activeNav === 'learn' }]}>Learn</a>
        <div class="nav-submenu">
          <span class="submenu-section">Chapters</span>
          <a href={url('/learn#chapter-1')}>1. Introduction</a>
          <a href={url('/learn#chapter-2')}>2. Extended Arithmetics</a>
          <a href={url('/learn#chapter-3')}>3. Data Structures</a>
          <a href={url('/learn#chapter-4')}>4. Functions</a>
          <a href={url('/learn#chapter-5')}>5. Program Structure</a>
          <a href={url('/learn#chapter-6')}>6. Advanced Processing</a>
          <a href={url('/learn#chapter-7')}>7. Input Data</a>
          <a href={url('/learn#chapter-8')}>8. Data Validation</a>
          <span class="submenu-section">Exercises</span>
          <a href={url('/learn#ex-greeting')}>Build a Greeting</a>
          <a href={url('/learn#ex-product')}>Product Total</a>
          <a href={url('/learn#ex-transform')}>Text Transform</a>
          <a href={url('/learn#ex-area')}>Rectangle Area</a>
          <a href={url('/learn#ex-filter-map')}>Filter and Double</a>
          <a href={url('/learn#ex-input')}>Order Total</a>
          <a href={url('/learn#ex-validate')}>Validate Data</a>
          <span class="submenu-section">Use Cases</span>
          <a href={url('/learn#uc-validation')}>Form Validation</a>
          <a href={url('/learn#uc-order')}>Order Processing</a>
          <a href={url('/learn#uc-subscription')}>Subscription Logic</a>
        </div>
      </div>
      <div class="nav-group">
        <a href={url('/reference')} class:list={[{ active: activeNav === 'doc' }]}>Reference</a>
        <div class="nav-submenu">
          <span class="submenu-section">Core</span>
          <a href={url('/reference#types')}>Types</a>
          <a href={url('/reference#literals')}>Literals</a>
          <a href={url('/reference#operators')}>Operators</a>
          <span class="submenu-section">Expressions</span>
          <a href={url('/reference#variables')}>Variables</a>
          <a href={url('/reference#conditionals')}>Conditionals</a>
          <a href={url('/reference#ranges')}>Range Membership</a>
          <span class="submenu-section">Data</span>
          <a href={url('/reference#tuples')}>Tuples</a>
          <a href={url('/reference#lists')}>Lists</a>
          <a href={url('/reference#input')}>Input Data</a>
          <span class="submenu-section">Functions</span>
          <a href={url('/reference#lambdas')}>Lambdas</a>
          <span class="submenu-section">Type System</span>
          <a href={url('/reference#type-selectors')}>Type Selectors</a>
          <a href={url('/reference#type-definitions')}>Type Definitions</a>
          <span class="submenu-section">Runtime</span>
          <a href={url('/reference#assertions')}>Assertions</a>
          <span class="submenu-section">Tools</span>
          <a href={url('/reference#javascript-api')}>JavaScript API</a>
          <a href={url('/reference#command-line')}>Command Line</a>
        </div>
      </div>
      <div class="nav-group">
        <a href={url('/stdlib')} class:list={[{ active: activeNav === 'stdlib' }]}>Stdlib</a>
        <div class="nav-submenu">
          <a href={url('/stdlib#type-selectors')}>Type Selectors</a>
          <a href={url('/stdlib#any')}>Any</a>
          <a href={url('/stdlib#date')}>Date</a>
          <a href={url('/stdlib#datetime')}>DateTime</a>
          <a href={url('/stdlib#duration')}>Duration</a>
          <a href={url('/stdlib#list')}>List</a>
          <a href={url('/stdlib#numeric')}>Numeric</a>
          <a href={url('/stdlib#string')}>String</a>
          <a href={url('/stdlib#data')}>Tuple (Data)</a>
        </div>
      </div>
      <a href={url('/blog')} class:list={[{ active: activeNav === 'blog' }]}>Blog</a>
      <a href={url('/about')} class:list={[{ active: activeNav === 'about' }]}>About</a>
      <a href={url('/security')} class:list={[{ active: activeNav === 'security' }]}>Security</a>
      <div class="nav-icons">
        <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme" title="Toggle light/dark mode">
          <span class="theme-icon">&#9790;</span>
        </button>
        <a href="https://github.com/enspirit/elo" target="_blank" rel="noopener noreferrer" class="github-link" aria-label="View on GitHub" title="View on GitHub">
          <svg viewBox="0 0 24 24" fill="currentColor" class="github-icon">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>
      </div>
    </nav>
  </header>

  <slot />

  <script>
    import { Application } from '@hotwired/stimulus';
    import PlaygroundController from '../scripts/controllers/playground_controller';
    import DocController from '../scripts/controllers/doc_controller';
    import StdlibSearchController from '../scripts/controllers/stdlib_search_controller';
    import LearnProgressController from '../scripts/controllers/learn_progress_controller';
    import ExercisesController from '../scripts/controllers/exercises_controller';
    import { highlightAll, highlightAllJS } from '../scripts/highlighter';

    // Start Stimulus application
    const application = Application.start();
    (window as any).Stimulus = application;

    // Register controllers
    application.register('playground', PlaygroundController);
    application.register('doc', DocController);
    application.register('stdlib-search', StdlibSearchController);
    application.register('learn-progress', LearnProgressController);
    application.register('exercises', ExercisesController);

    // Theme toggle functionality
    function initTheme() {
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = themeToggle?.querySelector('.theme-icon');

      updateIcon();

      themeToggle?.addEventListener('click', () => {
        document.body.classList.toggle('light-theme');
        const isLight = document.body.classList.contains('light-theme');
        localStorage.setItem('elo-theme', isLight ? 'light' : 'dark');
        updateIcon();
      });

      function updateIcon() {
        if (themeIcon) {
          const isLight = document.body.classList.contains('light-theme');
          themeIcon.innerHTML = isLight ? '&#9790;' : '&#9728;';
        }
      }
    }

    // Mobile menu toggle
    function initMobileMenu() {
      const toggle = document.getElementById('mobile-menu-toggle');
      const nav = document.getElementById('main-nav');

      toggle?.addEventListener('click', () => {
        nav?.classList.toggle('mobile-open');
      });

      // Make nav-group sections collapsible on mobile
      const navGroups = document.querySelectorAll('.nav-group');
      navGroups.forEach(group => {
        const link = group.querySelector(':scope > a');
        link?.addEventListener('click', (e) => {
          // Only toggle on mobile (when hamburger is visible)
          if (window.innerWidth <= 768) {
            e.preventDefault();
            group.classList.toggle('mobile-expanded');
          }
        });
      });
    }

    // Apply syntax highlighting and init
    document.addEventListener('DOMContentLoaded', () => {
      highlightAll('.example-code');
      highlightAllJS('.code-js');
      initTheme();
      initMobileMenu();
    });
  </script>

  <!-- Simple Analytics -->
  <script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
</body>
</html>
